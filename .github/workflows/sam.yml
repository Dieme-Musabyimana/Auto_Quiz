name: Run Test Bot

on:
  workflow_dispatch:
    inputs:
      run_as:
        description: 'Run Account AS'
        type: boolean
        default: false
      run_mos:
        description: 'Run Account MOS'
        type: boolean
        default: false
      run_bel:
        description: 'Run Account BEL'
        type: boolean
        default: false
      run_di:
        description: 'Run Account DI'
        type: boolean
        default: false
      run_dieu:
        description: 'Run Account DIEU'
        type: boolean
        default: false
      run_pat:
        description: 'Run Account PAT'
        type: boolean
        default: false
      run_sam:
        description: 'Run Account SAM'
        type: boolean
        default: false
      run_na:
        description: 'Run Account NA'
        type: boolean
        default: false
      run_da:
        description: 'Run Account DA'
        type: boolean
        default: false
      run_mu:
        description: 'Run Account MU'
        type: boolean
        default: false
      run_jon:
        description: 'Run Account JON'
        type: boolean
        default: false
      run_pie:
        description: 'Run Account PIE'
        type: boolean
        default: false
      run_th:
        description: 'Run Account TH'
        type: boolean
        default: false
      run_est:
        description: 'Run Account EST'
        type: boolean
        default: false
      run_pac:
        description: 'Run Account PAC'
        type: boolean
        default: false
      run_pont:
        description: 'Run Account PONT'
        type: boolean
        default: false
      run_sab:
        description: 'Run Account SAB'
        type: boolean
        default: false
      run_sore:
        description: 'Run Account SORE'
        type: boolean
        default: false

jobs:

jobs:
  run-bot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false 
      matrix:
        include:
          # --- Group 1: DoQuizTest.java ---
          - { account: AS, class: DoQuizTest, id: run_as }
          - { account: MOS, class: DoQuizTest, id: run_mos }
          - { account: BEL, class: DoQuizTest, id: run_bel }
          - { account: DI, class: DoQuizTest, id: run_di }
          - { account: DIEU, class: DoQuizTest, id: run_dieu }
          - { account: PAT, class: DoQuizTest, id: run_pat }
          # --- Group 2: DoQuiz2Test.java ---
          - { account: SAM, class: DoQuiz2Test, id: run_sam }
          - { account: NA, class: DoQuiz2Test, id: run_na }
          - { account: DA, class: DoQuiz2Test, id: run_da }
          - { account: MU, class: DoQuiz2Test, id: run_mu }
          - { account: JON, class: DoQuiz2Test, id: run_jon }
          - { account: PIE, class: DoQuiz2Test, id: run_pie }
          # --- Group 3: DoQuiz3Test.java ---
          - { account: TH, class: DoQuiz3Test, id: run_th }
          - { account: EST, class: DoQuiz3Test, id: run_est }
          - { account: PAC, class: DoQuiz3Test, id: run_pac }
          - { account: PONT, class: DoQuiz3Test, id: run_pont }
          - { account: SAB, class: DoQuiz3Test, id: run_sab }
          - { account: SORE, class: DoQuiz3Test, id: run_sore }

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if account should run
        id: check_selection
        run: |
          if [[ "${{ github.event.inputs[matrix.id] }}" == "true" ]]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Java
        if: steps.check_selection.outputs.should_run == 'true'
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
          cache: 'maven'

      - name: Install Playwright
        if: steps.check_selection.outputs.should_run == 'true'
        run: npx playwright install --with-deps chromium

      - name: Compile
        if: steps.check_selection.outputs.should_run == 'true'
        run: mvn clean test-compile

      - name: Set Account Secrets
        if: steps.check_selection.outputs.should_run == 'true'
        run: |
          # (Your existing case statement for secrets stays here exactly as it was)
          case "${{ matrix.account }}" in
            AS) echo "LOGIN_PHONE=${{ secrets.LOGIN_PHONE_AS }}" >> $GITHUB_ENV; echo "LOGIN_PIN=${{ secrets.LOGIN_PIN_AS }}" >> $GITHUB_ENV ;;
            # ... add all other accounts here ...
          esac

      - name: Run Quiz Bot
        if: steps.check_selection.outputs.should_run == 'true'
        env:
          LOGIN_PHONE: ${{ env.LOGIN_PHONE }}
          LOGIN_PIN: ${{ env.LOGIN_PIN }}
          API_KEY: ${{ secrets.API_KEY }}
        # MODIFIED: Uses matrix.class to pick DoQuizTest, DoQuiz2Test, or DoQuiz3Test
        run: mvn -e exec:java -Dexec.classpathScope="test" -Dexec.mainClass="${{ matrix.class }}" -Dexec.args="${{ matrix.account }}"

      - name: Save and Sync Memory
        if: steps.check_selection.outputs.should_run == 'true' && always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add statistics.json
          # MODIFIED: Pull with rebase to merge all account findings correctly
          if git commit -m "Update database [${{ matrix.account }}]"; then
            for i in {1..10}; do
              git pull --rebase origin main
              if git push; then exit 0; fi
              sleep 5
            done
          fi
